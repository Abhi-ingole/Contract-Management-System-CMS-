<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Dashboard</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Contract Management <br> System</h1>
            <nav>
        
                <a href="clients.html">Clients</a>
                <a href="projects.html">Projects</a>
                <a href="employees.html">Employees</a>
                <a href="suppliers.html">Suppliers</a>
                <a href="invoices.html">Invoices</a>
                <a href="payments.html">Payments</a>
                <a href="services.html">Services</a>
                <a href="materials.html">Materials</a>
                <a href="about.html">About</a>
                <a href="#" class="logout-btn" onclick="logout()">Logout</a>
            </nav>
        </div>
    </header>
<script>
    function logout() {
        fetch('/api/logout', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/login.html';
            }
        });
    }

    // ... (rest of your existing JavaScript)
</script>
    <main class="dashboard-main">
        <h2>Welcome, Admin</h2>
        <div class="dashboard-cards">
            <div class="card">
                <h3>Total Clients</h3>
                <p id="client-count">...</p>
            </div>
            <div class="card">
                <h3>Total Projects</h3>
                <p id="project-count">...</p>
            </div>
            <div class="card">
                <h3>Total Employees</h3>
                <p id="employee-count">...</p>
            </div>
            <div class="card">
                <h3>Total Invoices</h3>
                <p id="invoice-count">...</p>
            </div>
        </div>
       <h2 style="margin-top: 30px;">Project Status Breakdown</h2>

        <div class="dashboard-cards">
            <div class="card" style="border-left: 5px solid #007bff;">
                <h3>Working Projects (<span id="projects-working-count">...</span>)</h3>
                <p id="projects-working-names" class="project-list">...</p>
            </div>
            <div class="card" style="border-left: 5px solid #ffc107;">
                <h3>Pending/On Hold (<span id="projects-pending-count">...</span>)</h3>
                <p id="projects-pending-names" class="project-list">...</p>
            </div>
            <div class="card" style="border-left: 5px solid #28a745;">
                <h3>Projects Completed (<span id="projects-completed-count">...</span>)</h3>
                <p id="projects-completed-names" class="project-list">...</p>
            </div>
        </div>

        <button id="downloadMasterReportBtn" class="download-btn" style="width: 300px; margin-top: 30px;">
            Download All CMS Data Report
        </button>
    </main>
    
    <script>
        function logout() {
            fetch('/api/logout', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/login.html';
                }
            });
        }

        function fetchDashboardCounts() {
            fetch('/api/counts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Primary Counts
                    document.getElementById('client-count').textContent = data.clients;
                    document.getElementById('project-count').textContent = data.projects;
                    document.getElementById('employee-count').textContent = data.employees;
                    document.getElementById('invoice-count').textContent = data.invoices;
                    
                    // NEW Project Status Breakdown - Counts
                    document.getElementById('projects-working-count').textContent = data.projects_working;
                    document.getElementById('projects-pending-count').textContent = data.projects_pending;
                    document.getElementById('projects-completed-count').textContent = data.projects_completed;

                    // NEW Project Status Breakdown - Names
                    document.getElementById('projects-working-names').textContent = 
                        data.projects_working_names.replace(/; /g, ' | ');
                    document.getElementById('projects-pending-names').textContent = 
                        data.projects_pending_names.replace(/; /g, ' | ');
                    document.getElementById('projects-completed-names').textContent = 
                        data.projects_completed_names.replace(/; /g, ' | ');

                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // Set all counters to Error on failure
                    document.getElementById('client-count').textContent = 'Error';
                    document.getElementById('projects-working-names').textContent = 'Error loading names.';
                    document.getElementById('projects-pending-names').textContent = 'Error loading names.';
                    document.getElementById('projects-completed-names').textContent = 'Error loading names.';
                });
        }
        document.addEventListener('DOMContentLoaded', fetchDashboardCounts);

        // Add event listener to the master report button
        document.getElementById('downloadMasterReportBtn').addEventListener('click', function() {
            window.location.href = '/api/downloadMasterReport';
        });
    </script>
</body>
</html>